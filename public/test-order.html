<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Test Order Endpoint</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test de l'endpoint Order</h1>
        
        <div style="margin-bottom: 20px;">
            <button onclick="testServer()">1. Tester le serveur (sans auth)</button>
            <button onclick="fetchCsrfToken()">2. Récupérer CSRF Token</button>
            <button onclick="testServerWithAuth()">3. Tester avec auth (sans CSRF)</button>
        </div>
        
        <form id="orderForm">
            <div class="form-group">
                <label for="prescription_number">Numéro d'ordonnance:</label>
                <input type="text" id="prescription_number" name="prescription_number" value="ORD-12345" required>
            </div>
            
            <div class="form-group">
                <label for="phone_number">Téléphone:</label>
                <input type="tel" id="phone_number" name="phone_number" value="0123456789" required>
            </div>
            
            <div class="form-group">
                <label for="payment_method">Méthode de paiement:</label>
                <select id="payment_method" name="payment_method" required>
                    <option value="tmoney">TMoney</option>
                    <option value="flooz">Flooz</option>
                    <option value="carte_bancaire">Carte bancaire</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="prescription_images">Images d'ordonnance:</label>
                <input type="file" id="prescription_images" name="prescription_images[]" accept="image/*" multiple required>
            </div>
            
            <div class="form-group">
                <label for="notes">Notes (optionnel):</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Notes supplémentaires..."></textarea>
            </div>
            
            <button type="submit">Envoyer la commande</button>
        </form>
        
        <div id="result"></div>
    </div>

    <script>
        // Variables globales
        let csrfToken = '';
        
        // Fonction pour récupérer le token CSRF
        async function fetchCsrfToken() {
            const resultDiv = document.getElementById('result');
            try {
                const response = await fetch('/csrf-token');
                csrfToken = await response.text();
                document.querySelector('meta[name="csrf-token"]').setAttribute('content', csrfToken);
                
                resultDiv.innerHTML = `
                    <div class="success">✅ Token CSRF récupéré: ${csrfToken.substring(0, 20)}...</div>
                `;
                console.log('CSRF Token:', csrfToken);
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ Erreur récupération CSRF: ${error.message}</div>
                `;
            }
        }
        
        // Fonction pour tester le serveur sans authentification
        async function testServer() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div>Test du serveur...</div>';
            
            const formData = new FormData();
            formData.append('prescription_number', 'TEST-123');
            formData.append('phone_number', '0123456789');
            formData.append('payment_method', 'tmoney');
            formData.append('notes', 'Test sans authentification');
            
            try {
                const response = await fetch('/test-order-no-auth', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Response status:', response.status);
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = { error: 'Réponse non-JSON', raw: responseText };
                }
                
                resultDiv.innerHTML = `
                    <div class="${response.ok ? 'success' : 'error'}">
                        ${response.ok ? '✅ Serveur accessible' : '❌ Erreur serveur'} (Status: ${response.status})
                    </div>
                    <div class="log">Réponse: ${JSON.stringify(data, null, 2)}</div>
                `;
                
                // Si le serveur fonctionne, récupérer automatiquement le CSRF
                if (response.ok && data.csrf_token) {
                    csrfToken = data.csrf_token;
                    document.querySelector('meta[name="csrf-token"]').setAttribute('content', csrfToken);
                }
                
            } catch (error) {
                console.error('Test server error:', error);
                resultDiv.innerHTML = `
                    <div class="error">❌ Erreur de connexion: ${error.message}</div>
                `;
            }
        }
        
        // Charger automatiquement le token CSRF au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            fetchCsrfToken();
        });
        
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div>Envoi en cours...</div>';
            
            const formData = new FormData(this);
            
            // Utiliser le token CSRF récupéré
            if (!csrfToken) {
                await fetchCsrfToken();
            }
            
            console.log('CSRF Token:', csrfToken);
            console.log('FormData entries:');
            for (let pair of formData.entries()) {
                console.log(pair[0], pair[1]);
            }
            
            try {
                const response = await fetch('/order', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = { error: 'Réponse non-JSON', raw: responseText };
                }
                
                resultDiv.innerHTML = `
                    <div class="${response.ok ? 'success' : 'error'}">
                        Status: ${response.status}<br>
                        ${response.ok ? 'Succès!' : 'Erreur'}
                    </div>
                    <div class="log">Réponse: ${JSON.stringify(data, null, 2)}</div>
                `;
                
            } catch (error) {
                console.error('Fetch error:', error);
                resultDiv.innerHTML = `
                    <div class="error">Erreur de réseau: ${error.message}</div>
                `;
            }
        });
    </script>
</body>
</html>
